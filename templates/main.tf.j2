{% macro tf_primitive(primitive_name, primitive_config, primitive_index) -%}
{% set tf=namespace(**dict(default.get(primitive_name, {}).get('tf', {}).items() + primitive_config.get('tf', {}).items())) -%}
{% set var=namespace(**dict(default.get(primitive_name, {}).get('var', {}).items() + primitive_config.get('var', {}).items())) -%}
{% set tag=namespace(items = dict(default.get(primitive_name, {}).get('tags', {}).items() + primitive_config.get('tags', {}).items()).items()) -%}
{% set name=primitive_config.get('name', default.get(primitive_name, {}).get('name', primitive_index)) -%}
{% set templates=primitive_config.get('templates', default.get(primitive_name, {}).get('templates', [primitive_name + '/main.tf.j2',])) -%}
{% for template in templates -%}

{% include template with context %}

{% endfor -%}
{%- endmacro %}
{% if skip_project_name_domain_prefix == true %}
{% set domain_name = project_env_zone %}
{% else %}
{% set domain_name = project_name + "." + project_env_zone %}
{% endif %}

##### begin:header
{% include 'header.tf.j2' %}
##### end:header
{% for primitive_dict in primitive -%}
{% set primitive_index = loop.index | to_json -%}
{% for primitive_name, primitive_config in primitive_dict.items() -%}
{% if primitive_config == True -%}
{% set primitive_config = {} -%}
{%- endif  %}
{% if primitive_config is not mapping  -%}
{% set primitive_config = dict(name=primitive_config) %}
{%- endif  %}
##### begin:{{ primitive_name }}:{{primitive_index}}
{{ tf_primitive(primitive_name, primitive_config, primitive_index) }}
##### end:{{ primitive_name }}:{{primitive_index}}
{% endfor -%}
{% endfor %}
##### begin:footer
{% include 'footer.tf.j2' %}
##### end:footer