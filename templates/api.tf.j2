resource "aws_api_gateway_rest_api" "site" {
  name = "{{ project_type }}-{{ project_name }}-login"
}

resource "aws_api_gateway_model" "login" {
  rest_api_id  = "${aws_api_gateway_rest_api.site.id}"
  name         = "Login"
  content_type = "application/json"

  schema = <<EOF
{
  "$schema" : "http://json-schema.org/draft-04/schema#",
  "title" : "Login Schema",
  "type" : "object",
  "properties" : {
    "username" : { "type" : "string" },
    "password" : { "type" : "string" }
  }
}
EOF
}

resource "aws_api_gateway_resource" "login" {
  rest_api_id = "${aws_api_gateway_rest_api.site.id}"
  parent_id   = "${aws_api_gateway_rest_api.site.root_resource_id}"
  path_part   = "login"
}


# /login - OPTIONS
resource "aws_api_gateway_method" "login_options" {
  rest_api_id   = "${aws_api_gateway_rest_api.site.id}"
  resource_id   = "${aws_api_gateway_resource.login.id}"
  http_method   = "OPTIONS"
  authorization = "NONE"
}

resource "aws_api_gateway_integration" "login_options" {
  rest_api_id = "${aws_api_gateway_rest_api.site.id}"
  resource_id = "${aws_api_gateway_resource.login.id}"
  http_method = "${aws_api_gateway_method.login_options.http_method}"

  type                 = "MOCK"
  passthrough_behavior = "WHEN_NO_TEMPLATES"
  request_templates    = {
    "application/json" = <<EOF
{
  "statusCode": 200
}
EOF
  }
}

resource "aws_api_gateway_method_response" "login_options" {
  rest_api_id = "${aws_api_gateway_rest_api.site.id}"
  resource_id = "${aws_api_gateway_resource.login.id}"
  http_method = "${aws_api_gateway_method.login_options.http_method}"

  status_code = "200"
  response_models = {
    "application/json" = "Empty"
  }
}

resource "aws_api_gateway_integration_response" "login_options" {
  rest_api_id       = "${aws_api_gateway_rest_api.site.id}"
  resource_id       = "${aws_api_gateway_resource.login.id}"
  http_method       = "${aws_api_gateway_method.login_options.http_method}"
  status_code       = "${aws_api_gateway_method_response.login_options.status_code}"
  selection_pattern = ""
}

# /login - POST
resource "aws_api_gateway_method" "login_post" {
  rest_api_id   = "${aws_api_gateway_rest_api.site.id}"
  resource_id   = "${aws_api_gateway_resource.login.id}"
  http_method   = "POST"
  authorization = "NONE"

  request_models = {
    "application/json" = "${aws_api_gateway_model.login.name}"
  }
  request_parameters = {
    "method.request.header.Content-Type" = true,
    "method.request.header.Referer" = false
  }
}

resource "aws_api_gateway_integration" "login_post" {
  rest_api_id = "${aws_api_gateway_rest_api.site.id}"
  resource_id = "${aws_api_gateway_resource.login.id}"
  http_method = "${aws_api_gateway_method.login_post.http_method}"

  integration_http_method = "POST"
  type                    = "AWS_PROXY"
  uri                     = "${aws_lambda_function.login.invoke_arn}"
}

resource "aws_api_gateway_method_response" "login_post" {
  rest_api_id = "${aws_api_gateway_rest_api.site.id}"
  resource_id = "${aws_api_gateway_resource.login.id}"
  http_method = "${aws_api_gateway_method.login_post.http_method}"

  status_code = "200"
  response_models = {
    "application/json" = "Empty"
  }
}

resource "aws_api_gateway_deployment" "env" {
  rest_api_id = "${aws_api_gateway_rest_api.site.id}"
  depends_on = [
    "aws_api_gateway_integration.login_options",
    "aws_api_gateway_integration.login_post",
    "aws_lambda_function.login"
  ]
  stage_name = "{{ project_deployment_environment }}"
}

resource "aws_api_gateway_stage" "env" {
  rest_api_id   = "${aws_api_gateway_rest_api.site.id}"
  deployment_id = "${aws_api_gateway_deployment.env.id}"
  stage_name    = "${aws_api_gateway_deployment.env.stage_name}"
}

resource "aws_api_gateway_domain_name" "env" {
{% if project_deployment_environment == 'prod' or skip_env_domain_prefix == true %}
  domain_name = "api.{{ project_name }}.{{ project_env_zone }}"
{% else %}
  domain_name = "api.{{ project_deployment_environment }}.{{ project_name }}.{{ project_env_zone }}"
{% endif %}
  certificate_arn = "${aws_acm_certificate.default.arn}"
}

resource "aws_api_gateway_base_path_mapping" "site" {
  api_id      = "${aws_api_gateway_rest_api.site.id}"
  stage_name  = "${aws_api_gateway_stage.env.stage_name}"
  domain_name = "${aws_api_gateway_domain_name.env.domain_name}"
}
