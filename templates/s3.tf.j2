resource "aws_s3_bucket" "website_bucket" {

  provider = "aws.{{ aws_region }}"
  bucket   = "{{ s3_bucket_name }}"
  policy  = <<EOF
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Sid": "PrivateListGetBucket",
            "Effect": "Allow",
            "Principal": {
                "AWS": [
                    "${aws_iam_user.deployer.arn}"
                ] 
            },
            "Action": [
                "s3:GetBucketLocation",
                "s3:ListBucket"
            ],
            "Resource": [
                "arn:aws:s3:::{{ s3_bucket_name }}"
            ]
        },
        {
            "Sid": "PrivateGetPutObject",
            "Effect": "Allow",
            "Principal": {
                "AWS": [
                    "${aws_iam_user.deployer.arn}"
                ]
            },
            "Action": [
                "s3:Get*",
                "s3:Put*",
                "s3:Delete*"
            ],
            "Resource": [
                "arn:aws:s3:::{{ s3_bucket_name }}/*"
            ]
        }
    ]
}
EOF

}

resource "aws_iam_policy" "site_deployer_policy" {
  provider    = "aws.{{ aws_region }}"
  name        = "deployer.{{ project_name }}.{{ project_env_name }}"
  path        = "/"
  description = "Policy allowing to publish a new version of the website to the S3 bucket"
  policy      = <<EOF
{
    "Version": "2012-10-17",
    "Statement": [

        {
            "Effect": "Allow",
            "Action": [
                "s3:GetObject",
                "s3:PutObject",
                "s3:PutObjectAcl",
            ],
            "Resource": "arn:aws:s3:::{{ s3_bucket_name }}/*"
        },
        {
            "Effect": "Allow",
            "Action": [
                "s3:ListAllMyBuckets"
            ],
            "Resource": "*"
        }
    ]
}
EOF
}

resource "aws_iam_policy_attachment" "site-deployer-attach-user-policy" {
  provider   = "aws.{{ aws_region }}"
  name       = "{{ s3_bucket_name }}-deployer-policy"
  users      = ["${aws_iam_user.deployer.name}"]
  policy_arn = "${aws_iam_policy.site_deployer_policy.arn}"
}

resource "aws_iam_user" "deployer" {
  name = "deploy@{{ project_name }}.{{ project_deployment_environment }}"
  path = "/"
}

resource "aws_iam_access_key" "deployer" {
  user = "${aws_iam_user.deployer.name}"
}
